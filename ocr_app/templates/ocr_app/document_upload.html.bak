{% extends "ocr_app/base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-center">Document Upload</h2>
                </div>
                <div class="card-body">
                    {% if messages %}
                    <div class="messages">
                        {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="document" class="form-label">Select Document</label>
                            <input type="file" class="form-control" id="document" name="document" required>
                            <div class="invalid-feedback">
                                Please select a document to upload.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="document_type" class="form-label">Document Type</label>
                            <select class="form-select" id="document_type" name="document_type" required onchange="toggleCustomPromptTemplate()">
                                <option value="">Choose...</option>
                                <option value="loan">Loan Document</option>
                                <option value="property">Property Document</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a document type.
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="use_custom_prompt" name="use_custom_prompt" onchange="toggleCustomPrompt()">
                                <label class="form-check-label" for="use_custom_prompt">Use Custom Extraction Prompt</label>
                            </div>
                        </div>

                        <div class="mb-3" id="custom_prompt_container" style="display: none;">
                            <label for="custom_prompt" class="form-label">Custom Extraction Prompt</label>
                            <div class="mb-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="show_template_btn" onclick="showPromptTemplate()">
                                    Show Default Template
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="load_saved_prompt_btn" onclick="loadSavedPrompt()" style="display: none;">
                                    Load Saved Prompt
                                </button>
                            </div>
                            <textarea class="form-control" id="custom_prompt" name="custom_prompt" rows="10" placeholder="Enter your custom extraction prompt here..."></textarea>
                            <div class="form-text">
                                Specify the fields to extract in JSON format. Make sure to include instructions for the AI to return valid JSON.
                            </div>
                        </div>

                        <div class="mb-3" id="save_prompt_container" style="display: none;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="save_prompt" name="save_prompt">
                                <label class="form-check-label" for="save_prompt">Save this prompt for future use</label>
                            </div>
                            <div id="prompt_name_container" style="display: none;">
                                <label for="prompt_name" class="form-label">Prompt Name</label>
                                <input type="text" class="form-control" id="prompt_name" name="prompt_name" placeholder="Enter a name for this prompt">
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Upload & Process</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if processed_data %}
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header">
                        <h3>Processed Document Results</h3>
                    </div>
                    <div class="card-body">
                        {% if document_type == 'loan' %}
                        <div class="row mb-3">
                            <div class="col-12 text-end">
                                <a href="{% url 'ocr_app:download-json' document_type=document_type document_id=loan_doc.id %}" class="btn btn-success me-2">
                                    <i class="fas fa-download"></i> Download JSON
                                </a>
                                <a href="{% url 'ocr_app:download-csv' document_type=document_type document_id=loan_doc.id %}" class="btn btn-primary">
                                    <i class="fas fa-file-csv"></i> Download CSV
                                </a>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Original Text</h4>
                                <dl class="row">
                                    <dt class="col-sm-4">Borrower Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.borrower_name_original|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Date of Birth</dt>
                                    <dd class="col-sm-8">{{ loan_doc.date_of_birth|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Father's Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.father_name_original|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Spouse's Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.spouse_name_original|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Sex</dt>
                                    <dd class="col-sm-8">{{ loan_doc.sex_original|default:"-" }}</dd>

                                    <dt class="col-sm-4">Aadhar Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.aadhar_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">PAN Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.pan_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">Passport Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.passport_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">Driving License</dt>
                                    <dd class="col-sm-8">{{ loan_doc.driving_license|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Amount</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_amount|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Sanction Date</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_sanction_date|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Balance</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_balance|default:"-" }}</dd>

                                    <dt class="col-sm-4">Witness Details</dt>
                                    <dd class="col-sm-8">{{ loan_doc.witness_details|default:"-" }}</dd>

                                    <dt class="col-sm-4">EMI History</dt>
                                    <dd class="col-sm-8">{{ loan_doc.emi_history|default:"-" }}</dd>

                                    <dt class="col-sm-4">Credibility Summary</dt>
                                    <dd class="col-sm-8">{{ loan_doc.credibility_summary_original|default:"-" }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h4>English Translation</h4>
                                <dl class="row">
                                    <dt class="col-sm-4">Borrower Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.borrower_name_translated|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Date of Birth</dt>
                                    <dd class="col-sm-8">{{ loan_doc.date_of_birth|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Father's Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.father_name_translated|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Spouse's Name</dt>
                                    <dd class="col-sm-8">{{ loan_doc.spouse_name_translated|default:"-" }}</dd>
                                    
                                    <dt class="col-sm-4">Sex</dt>
                                    <dd class="col-sm-8">{{ loan_doc.sex_translated|default:"-" }}</dd>

                                    <dt class="col-sm-4">Aadhar Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.aadhar_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">PAN Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.pan_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">Passport Number</dt>
                                    <dd class="col-sm-8">{{ loan_doc.passport_number|default:"-" }}</dd>

                                    <dt class="col-sm-4">Driving License</dt>
                                    <dd class="col-sm-8">{{ loan_doc.driving_license|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Purpose</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_purpose_translated|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Amount</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_amount|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Sanction Date</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_sanction_date|default:"-" }}</dd>

                                    <dt class="col-sm-4">Loan Balance</dt>
                                    <dd class="col-sm-8">{{ loan_doc.loan_balance|default:"-" }}</dd>

                                    <dt class="col-sm-4">Witness Details</dt>
                                    <dd class="col-sm-8">{{ loan_doc.witness_details|default:"-" }}</dd>

                                    <dt class="col-sm-4">EMI History</dt>
                                    <dd class="col-sm-8">{{ loan_doc.emi_history|default:"-" }}</dd>

                                    <dt class="col-sm-4">Credibility Summary</dt>
                                    <dd class="col-sm-8">{{ loan_doc.credibility_summary_translated|default:"-" }}</dd>

                                    <dt class="col-sm-4">Languages Detected</dt>
                                    <dd class="col-sm-8">
                                        {% for field, lang in languages_detected %}
                                            {% if lang != 'en' and lang != 'none' and lang != '' and lang %}
                                                <div>{{ field }} was in : {{ lang }}</div>
                                            {% endif %}
                                        {% empty %}
                                            <div>All fields are in English</div>
                                        {% endfor %}
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        {% elif document_type == 'property' %}
                        <div class="row mb-3">
                            <div class="col-12 text-end">
                                <a href="{% url 'ocr_app:download-json' document_type=document_type document_id=property_doc.id %}" class="btn btn-success me-2">
                                    <i class="fas fa-download"></i> Download JSON
                                </a>
                                <a href="{% url 'ocr_app:download-csv' document_type=document_type document_id=property_doc.id %}" class="btn btn-primary">
                                    <i class="fas fa-file-csv"></i> Download CSV
                                </a>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Property Owner -->
                            <div class="col-md-6 mb-3">
                                <h5>Property Owner</h5>
                                <div class="text-muted">Original ({{ property_doc.property_owner_language }}):</div>
                                <p>{{ property_doc.property_owner_original|default:"-" }}</p>
                                <div class="text-muted">English Translation:</div>
                                <p>{{ property_doc.property_owner_translated|default:"-" }}</p>
                            </div>

                            <!-- Property Area -->
                            <div class="col-md-6 mb-3">
                                <h5>Property Area</h5>
                                <div class="text-muted">Original ({{ property_doc.property_area_language }}):</div>
                                <p>{{ property_doc.property_area_original|default:"-" }}</p>
                                <div class="text-muted">English Translation:</div>
                                <p>{{ property_doc.property_area_translated|default:"-" }}</p>
                            </div>

                            <!-- Property Location -->
                            <div class="col-md-6 mb-3">
                                <h5>Property Location</h5>
                                <div class="text-muted">Original ({{ property_doc.property_location_language }}):</div>
                                <p>{{ property_doc.property_location_original|default:"-" }}</p>
                                <div class="text-muted">English Translation:</div>
                                <p>{{ property_doc.property_location_translated|default:"-" }}</p>
                            </div>

                            <!-- Property Coordinates -->
                            <div class="col-md-6 mb-3">
                                <h5>Property Coordinates</h5>
                                <p>{{ property_doc.property_coordinates|default:"-" }}</p>
                            </div>

                            <!-- Property Value -->
                            <div class="col-md-6 mb-3">
                                <h5>Property Value</h5>
                                <p>{{ property_doc.property_value|default:"-" }}</p>
                            </div>

                            <!-- Loan Limit -->
                            <div class="col-md-6 mb-3">
                                <h5>Loan Limit</h5>
                                <p>{{ property_doc.loan_limit|default:"-" }}</p>
                            </div>

                            <!-- Risk Summary -->
                            <div class="col-12 mb-3">
                                <h5>Risk Summary</h5>
                                <div class="text-muted">Original ({{ property_doc.risk_summary_language }}):</div>
                                <p>{{ property_doc.risk_summary_original|default:"-" }}</p>
                                <div class="text-muted">English Translation:</div>
                                <p>{{ property_doc.risk_summary_translated|default:"-" }}</p>
                            </div>
                        </div>
                        {% elif document_type == 'custom' %}
                        <div class="row mb-3">
                            <div class="col-12 text-end">
                                <a href="{% url 'ocr_app:download-json' document_type='custom' document_id=custom_extraction.id %}" class="btn btn-success me-2">
                                    <i class="fas fa-download"></i> Download JSON
                                </a>
                                <a href="{% url 'ocr_app:download-csv' document_type='custom' document_id=custom_extraction.id %}" class="btn btn-primary">
                                    <i class="fas fa-file-csv"></i> Download CSV
                                </a>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>Extracted Data</h4>
                                <div class="accordion" id="customDataAccordion">
                                    {% for key, value in custom_data.items %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" 
                                                    aria-controls="collapse{{ forloop.counter }}">
                                                {{ key }}
                                            </button>
                                        </h2>
                                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                                             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#customDataAccordion">
                                            <div class="accordion-body">
                                                {% if value.original %}
                                                    <div class="mb-2">
                                                        <strong>Original ({{ value.language }}):</strong>
                                                        <p>{{ value.original }}</p>
                                                    </div>
                                                    <div>
                                                        <strong>Translated:</strong>
                                                        <p>{{ value.translated }}</p>
                                                    </div>
                                                {% else %}
                                                    <p>{{ value }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if custom_extraction %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Custom Extraction Results</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in custom_extraction.extracted_data.items %}
                                    <tr>
                                        <td>{{ key }}</td>
                                        <td>
                                            {% if value.original is defined %}
                                                <strong>Original:</strong> {{ value.original }}<br>
                                                {% if value.language %}<strong>Language:</strong> {{ value.language }}<br>{% endif %}
                                                {% if value.translated %}<strong>Translated:</strong> {{ value.translated }}{% endif %}
                                            {% else %}
                                                {% if value|is_list %}
                                                    <ul>
                                                        {% for item in value %}
                                                            <li>{{ item }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% elif value|is_dict %}
                                                    <pre>{{ value|pprint }}</pre>
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'ocr_app:download-json' 'custom' custom_extraction.id %}" class="btn btn-primary">Download JSON</a>
                        <a href="{% url 'ocr_app:download-csv' 'custom' custom_extraction.id %}" class="btn btn-success">Download CSV</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Form validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
})()

// Toggle custom prompt textarea
function toggleCustomPrompt() {
    const useCustomPrompt = document.getElementById('use_custom_prompt').checked;
    document.getElementById('custom_prompt_container').style.display = useCustomPrompt ? 'block' : 'none';
    document.getElementById('save_prompt_container').style.display = useCustomPrompt ? 'block' : 'none';
}

// Toggle save prompt name field
document.getElementById('save_prompt').addEventListener('change', function() {
    document.getElementById('prompt_name_container').style.display = this.checked ? 'block' : 'none';
});

// Show default prompt template based on document type
function toggleCustomPromptTemplate() {
    const docType = document.getElementById('document_type').value;
    if (docType) {
        document.getElementById('show_template_btn').style.display = 'inline-block';
    } else {
        document.getElementById('show_template_btn').style.display = 'none';
    }
}

// Show default prompt template
function showPromptTemplate() {
    const docType = document.getElementById('document_type').value;
    const promptTextarea = document.getElementById('custom_prompt');
    
    if (docType === 'loan') {
        promptTextarea.value = `Please extract the following information from this document image, keeping any text in its original language. Return the data in valid JSON format with these fields:
{
    "borrower_name": "",
    "date_of_birth": "",
    "sex": "",
    "father_name": "",
    "spouse_name": "",
    "aadhar_number": "",
    "pan_number": "",
    "passport_number": "",
    "driving_license": "",
    "loan_amount": "",
    "loan_sanction_date": "",
    "loan_balance": "",
    "witness_details": [],
    "emi_history": [],
    "credibility_summary": ""
}

Important:
1. Return ONLY the JSON object, no additional text
2. Use YYYY-MM-DD format for dates
3. Remove any currency symbols and special characters from numbers
4. If a field is not found in the image, leave it empty
5. For loan amount, include the currency symbol (e.g., "₹")
6. For witness_details and emi_history, use arrays even if empty
7. Keep all text in its original language - do not translate`;
    } else if (docType === 'property') {
        promptTextarea.value = `Please extract the following information from this document image, keeping any text in its original language. Return the data in valid JSON format with these fields:
{
    "property_owner": "",
    "property_area": "",
    "property_location": "",
    "property_coordinates": "",
    "property_value": "",
    "loan_limit": "",
    "risk_summary": ""
}

Important:
1. Return ONLY the JSON object, no additional text
2. Remove any currency symbols and special characters from numbers
3. If a field is not found in the image, leave it empty
4. For property_area, include the unit (e.g., "1200 sq ft")
5. For property_value, property_limit, include the currency symbol (e.g., "₹")  
6. For property_coordinates, use the format "latitude° N/S, longitude° E/W"
7. For risk_summary, provide a brief assessment of the property's risk factors
8. Keep all text in its original language - do not translate`;
    }
}

// Function to load saved prompts (will be implemented with AJAX)
function loadSavedPrompt() {
    // This would be implemented with AJAX to fetch saved prompts
    alert('This feature will load your saved prompts. Implementation pending.');
}
</script>
{% endblock %}